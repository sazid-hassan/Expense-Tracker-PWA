#!/usr/bin/env node

/**
 * Script to automatically update background images configuration
 * This script scans the public/bg-images directory and updates the backgroundImages.ts file
 * 
 * Usage: node scripts/update-background-images.js
 */

const fs = require('fs');
const path = require('path');

const BG_IMAGES_DIR = path.join(__dirname, '../public/bg-images');
const OUTPUT_FILE = path.join(__dirname, '../app/utils/backgroundImages.ts');

function capitalizeFirst(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function formatName(dirName) {
  // Convert kebab-case to Title Case
  return dirName
    .split('-')
    .map(word => capitalizeFirst(word))
    .join(' ');
}

function scanBackgroundImages() {
  if (!fs.existsSync(BG_IMAGES_DIR)) {
    console.error('Background images directory not found:', BG_IMAGES_DIR);
    return [];
  }

  const directories = fs.readdirSync(BG_IMAGES_DIR, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name);

  const backgroundImages = [];

  for (const dir of directories) {
    const dirPath = path.join(BG_IMAGES_DIR, dir);
    const files = fs.readdirSync(dirPath);
    
    // Find the first image file (jpg, jpeg, png, webp)
    const imageFile = files.find(file => 
      /\.(jpg|jpeg|png|webp)$/i.test(file)
    );

    if (imageFile) {
      backgroundImages.push({
        id: dir,
        name: formatName(dir),
        path: dir,
        imagePath: `/bg-images/${dir}/${imageFile}`
      });
    }
  }

  return backgroundImages.sort((a, b) => a.name.localeCompare(b.name));
}

function generateBackgroundImagesFile(backgroundImages) {
  const template = `import { BackgroundImageInfo } from '../types';

// Configuration for background images
// This array defines the available background images and their properties
// To add a new background image, simply add a new entry to this array
// This file is auto-generated by scripts/update-background-images.js
const backgroundImageConfig: BackgroundImageInfo[] = [
${backgroundImages.map(bg => `  {
    id: '${bg.id}',
    name: '${bg.name}',
    path: '${bg.path}',
    imagePath: '${bg.imagePath}'
  }`).join(',\n')}
];

// Function to get all available background images
export const getAllBackgroundImages = (): BackgroundImageInfo[] => {
  return backgroundImageConfig;
};

// Function to get background image info by ID
export const getBackgroundImageInfo = (id: string): BackgroundImageInfo | undefined => {
  return backgroundImageConfig.find(bg => bg.id === id);
};

// Function to get background image path by ID
export const getBackgroundImagePath = (id: string): string => {
  const bgInfo = getBackgroundImageInfo(id);
  return bgInfo ? bgInfo.imagePath : '/bg-images/paper/paper-desktop.jpg'; // fallback
};
`;

  return template;
}

function main() {
  console.log('Scanning background images directory...');
  
  const backgroundImages = scanBackgroundImages();
  
  if (backgroundImages.length === 0) {
    console.log('No background images found.');
    return;
  }

  console.log(`Found ${backgroundImages.length} background images:`);
  backgroundImages.forEach(bg => {
    console.log(`  - ${bg.name} (${bg.id})`);
  });

  const fileContent = generateBackgroundImagesFile(backgroundImages);
  
  // Ensure the output directory exists
  const outputDir = path.dirname(OUTPUT_FILE);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  fs.writeFileSync(OUTPUT_FILE, fileContent);
  console.log(`\nBackground images configuration updated: ${OUTPUT_FILE}`);
}

if (require.main === module) {
  main();
}

module.exports = { scanBackgroundImages, generateBackgroundImagesFile };
